<!DOCTYPE html>
<html lang="en">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
* {
    margin:  0px;
    padding: 0px;
    border:  0px; 
}

html {
    height: 100%;
    font: 14px Verdana, Arial, Helvetica, sans-serif;
}

body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

div {
    text-align: justify;	
}

p {
    padding: 5px;
}

ul {
    padding-left: 20px;
}

li {
    padding-top: 2px;
    padding-bottom: 2px;
}

a, a:link, a:active, a:visited {
   #color: #0000EE;
   color: #0000DD;
   #color: red;
}

.background-header {
    background: #F7F7FF;
}

.background-menu {
    background: #D0E0FF;
}

.background-menu-line {
    background: #90A0C0;
}

.border-color-menu {
    border-color: #90A0C0;
}

.color-menu-item {
    color: #2020A0;
}

.color-menu-item-selected { 
    color: #E78C43; 
}

.background-menu-selected-top { 
    background: #C8D8E8;
}

.border-color-div-source-code {
    border-color: #909090;
}

.color-source-sql-comment {
    color: #008000;
}

.color-source-sql-string {
    color: #800060;
}

.color-source-sql-keyword {
    color: #000080;
}

.color-source-sql-block-border {
    color: #DD0000;
}

.color-source-shell {
    color: green;
}

.background-source-shell {
    background: black;    
}

.color-source-html-tag {
    color: #0000CD;
}

.color-source-html-tag-attrubites {
    color: #B22222;
}

.color-source-html-tag-value {
    color: #008000;
}

.color-source-html-comment {
    color: #808080;
}

.color-source-js-comment {
    color: #008000;
}

.color-source-js-keyword {
    color: #000080;
}

.color-source-js-string {
    color: #800060;
}

.div-page {
    #border: solid 3px red;
    display: flex;
    flex-wrap: nowrap;
}

.div-header-middle {
    #border: solid 3px green;
    display: flex; 
    align-items: center; 
    justify-content: center;
	text-align: center;
}

.div-header-sidebar {
    #border: solid 3px blue;
    display: flex;    
    justify-content: center; 
    align-items: center;
    width: 100%;
} 

.div-content {
    display: flex;
    flex-wrap: nowrap;
    #justify-content: space-evenly; 
    justify-content: space-between;
}

.div-content-panel-left {
    #border: solid 3px green;
    width:     260px;
    min-width: 260px;
    max-width: 260px;
    float: left;
    text-align: left;
    padding-top: 10px;
    padding-bottom: 15px;
} 

.div-content-body {
    #border: solid 3px blue;
    padding: 10px 30px 10px 10px;
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-top {
    border-top-style: solid;
    border-top-width: 2px;
} 

.menu-border-left {
    border-left-style: solid;
    border-left-width: 2px;
}

.menu-border-right {
    border-right-style: solid;
    border-right-width: 2px;
}

.menu-border-bottom {
    border-bottom-style: solid;
    border-bottom-width: 2px;
}

.menu-top-item {
    text-decoration: none;
    font-size: larger;
    white-space: nowrap;
}

.menu-top-item-selected {
    font-size: larger;
    font-weight: bold;
    white-space: nowrap;
}

.menu-panel-left-item {
    padding-left: 15px;
    text-decoration: none; 
    font-size: larger;
}

.menu-panel-left-item-selected {
    padding-left: 25px;
    font-size: larger;
    font-weight: bold;
}

.nav-static-line {
    font-size: larger;
    background: #D0E0FF;
}
    
.nav-static-line > ul {
    list-style: none;
    padding: 0px;
}

.nav-static-line > ul > li {
    #border: 2px solid red;
    padding: 0px;
    float: left;    
    position: relative;
    text-align: center;
    text-decoration: none;
}
   
.nav-static-line .item {
    padding: 7px;      
    display: block;
    text-align: center;
    text-decoration: none;
}

.nav-static-line .item-selected {
    font-weight: bold;
}

.nav-mobile {
    margin: 0 auto;
	float: left;
    background: #D0E0FF;
}
   
.nav-mobile ul {
    list-style: none;
    margin: 0 auto;
    padding: 0;
}

.nav-mobile li li {
	width: 160px;
}
   
.nav-mobile > ul > li {
    float: left;
    position: relative;
    text-align: left;
    text-decoration: none;
}

.nav-mobile-group-root {
    display: none;
    position: absolute;
    top: 100%;
}

.nav-mobile li:hover > .nav-mobile-group-root {
    display: block;
}

.nav-mobile-group-child {
	display: none;
	position: absolute;
	left: 100%;
	top: 0;
}
    
.nav-mobile li li:hover > .nav-mobile-group-child-1 {
	display: block;
}

.nav-mobile li li li:hover > .nav-mobile-group-child-2 {
	display: block;
}

.nav-mobile-item {  
    padding: 6px;    
    display: block;
    text-align: left;
    text-decoration: none;
    color: #2020A0;	
}

.nav-mobile-item:hover {
   background: #2F718E;
}

.ul-articles li {
    padding-top: 17px;
}

.div-video-iframe {
    width: 560px;
    height: 315px;
}

.div-source-code {
    #border: solid 3px red;
    overflow:scroll;
    min-width: 95%;
    max-width: 200px;   
    border-style: solid;
    border-width: 1px; 
    padding: 2px 3px; 
    font-family: monospace;
    text-align: left;
}

.div-download {
    border-style: solid;
    border-width: 1px;  
    text-align: center;
}

.a-download {
    text-decoration: none;
}

.div-documentation-synopsis {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:    0px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

.div-documentation-desc {
    #border: solid 3px red;
    margin-left:    30px;
    margin-right:  100px; 
    margin-top:      3px;
    margin-bottom:   0px;
}

@media (max-width: 900px) {

    #header-desktop {
        display: none;
    }

    #menu-top-line-1 {
        display: none;
    }

    .div-content-panel-left {
        display: none;
    } 

    .div-content-body {
        border-left-width: 0px;
        padding: 5px;
    }

    .div-video-iframe {
        width: 370px;
        height: 210px;
    }

}

@media not (max-width: 900px) {

    #header-mobile {
        display: none;
    }

}

.button-top {
  display: none; 
  position: fixed;
  right: 10px;
  bottom: 40px;
  cursor: pointer;
  font-size: 18px;
  padding: 5px 8px;
  border-style: solid; 
  border-width: 2px;
}

.button-top-visible {
  display: block;
} 
</style>


<title>PGHist | Documentation</title>
	
</head>
<body>

<div id="header-desktop" class="div-page background-header menu-border-bottom border-color-menu" style="justify-content: center; padding: 10px;">

  <h1>PGHist | Documentation</h1>

</div>


<div class='div-page' style='flex: 1; clear:both;'>

  <div class='div-content-panel-left'>
    

<ul>
<li><a href="#usage_method">Usage method</a></li>
<li><a href="#security">Security</a></li>
<li><a href="#hist_enable">pghist.hist_enable</a></li>
<li><a href="#view_hist">[schema].[table]_hist</a></li>
<li><a href="#table_changes">[schema].[table]_changes</a></li>
<li><a href="#table_at_timestamp">[schema].[table]_at_timestamp</a></li>
<li><a href="#hist_disable">pghist.hist_disable</a></li>
<li><a href="#hist_expression_desc">SQL expressions of descriptions</a></li>
<li><a href="#hist_custom_funcs">Customization functions</a></li>
<li><a href="#hist_table">History table</a></li>
<li><a href="#common_tables">Common tables</a></li>
<li><a href="#pghist_version">pghist.pghist_version</a></li>
<li><a href="#hist_sql_log">pghist.hist_sql_log</a></li>
</ul>


  </div>

  <div class='div-content-body border-content-body border-color-menu'>
    

<a id="usage_method"></a>
<p style="font-size:larger;"><b>Usage method</b></p>
<br>

Call of <a href="#hist_enable">pghist.hist_enable</a> procedure creates 3 objects in the table schema for working with history:
<br>
<br>
<b>1. <a href="#view_hist">[schema].[table]_hist</a> view</b> is a change log (audit) for developers to analyze data problems
<br><br>
SQL query and application name allow to determine the location in the source code, transaction identifier - changes in other tables and SQL queries.
<br><br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 250px;">
<pre><span class="color-source-sql-comment">-- Create schema and table, enable history, change data </span>
<span class="color-source-sql-keyword">drop</span> <span class="color-source-sql-keyword">schema</span> <span class="color-source-sql-keyword">if</span> <span class="color-source-sql-keyword">exists</span> example <span class="color-source-sql-keyword">cascade</span>;
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">schema</span> example;

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.<span class="color-source-sql-keyword">document</span>(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  number <span class="color-source-sql-keyword">varchar</span>(10),
  amount <span class="color-source-sql-keyword">numeric</span>(10,2)
);

<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'document'</span>);

<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">values</span> (11, <span class="color-source-sql-string">'#10'</span>, 100);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">values</span> (12, <span class="color-source-sql-string">'#20'</span>, 200);
<span class="color-source-sql-keyword">update</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">set</span> number=<span class="color-source-sql-string">'#20/2'</span>,amount=210 <span class="color-source-sql-keyword">where</span> id=12;
<span class="color-source-sql-keyword">update</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">set</span> amount=220 <span class="color-source-sql-keyword">where</span> id=12;
<span class="color-source-sql-keyword">delete</span> <span class="color-source-sql-keyword">from</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">where</span> id=11;

<span class="color-source-sql-comment">-- Select full info</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist;

<span class="color-source-sql-comment">-- Select partial info by id</span>
<span class="color-source-sql-keyword">select</span> hist_timestamp,hist_operation,hist_db_user,amount_old 
  <span class="color-source-sql-keyword">from</span> example.document_hist
  <span class="color-source-sql-keyword">where</span> id=12 <span class="color-source-sql-keyword">and</span> (hist_operation!=<span class="color-source-sql-string">'UPDATE'</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-string">'amount'</span>=<span class="color-source-sql-keyword">any</span>(hist_update_columns))
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> hist_statement_id;

<span class="color-source-sql-comment">-- Select partial info with current values</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist
<span class="color-source-sql-keyword">union</span> <span class="color-source-sql-keyword">all</span> 
<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-string">'[CURRENT_VALUES]'</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,<span class="color-source-sql-keyword">null</span>,* <span class="color-source-sql-keyword">from</span> example.<span class="color-source-sql-keyword">document</span>
<span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> id,1;

<span class="color-source-sql-comment">-- Create extended view and grant select on it to developer</span>
<span class="color-source-sql-comment">-- (alternatively to 'grant select on all tables in schema pghist to developer');  </span>
<span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_data&dollar;example_document h  
  <span class="color-source-sql-keyword">join</span> pghist.hist_statement s <span class="color-source-sql-keyword">on</span> s.id = h.hist_statement_id
  <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash = s.query_hash
  <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id = s.transaction_id
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> h.hist_statement_id, h.id;
 
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">view</span> example.document_hist_ext <span class="color-source-sql-keyword">as</span>  
  <span class="color-source-sql-keyword">select</span> h.id,t.timestamp_commit,t.db_client_addr,q.<span class="color-source-sql-keyword">text</span> query_text
    <span class="color-source-sql-keyword">from</span> pghist.hist_data&dollar;example_document h  
    <span class="color-source-sql-keyword">join</span> pghist.hist_statement s <span class="color-source-sql-keyword">on</span> s.id = h.hist_statement_id
    <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash = s.query_hash
    <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id = s.transaction_id
    <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> h.hist_statement_id, h.id;
   
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist_ext <span class="color-source-sql-keyword">where</span> id=12;   

<span class="color-source-sql-keyword">grant</span> <span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">on</span> example.document_hist_ext <span class="color-source-sql-keyword">to</span> developer_1;      
</pre>
</div>

<br>
<br>
<b>2. <a href="#table_changes">[schema].[table]_changes</a> function</b> returns a set of data to display changes to the user
<br><br>
Information is displayed in the old-new value format with a description.
<br><br>
Display identifiers and foreign keys to the user is uninformative, so for each row and field values description is displayed that can be overridden via <a href="#hist_expression_desc">SQL expression</a>.
By default, comment table with the primary key is returned for a row description, first text field of related table is returned for a column that is the foreign key,
for others - value. Thus, can display to user a description without value.
<br><br>
When enabling history for detail table, must specify the master table, foreign key values will be stored and indexed.
By default, when changes are received in the master table, changes in the detail tables will also be returned.
<br><br>
Some columns (for example, username) can be redefined via <a href="#hist_custom_funcs">customization functions</a>.
<br><br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 250px;">
<pre><span class="color-source-sql-comment">-- Create schema and tables</span>
<span class="color-source-sql-keyword">drop</span> <span class="color-source-sql-keyword">schema</span> <span class="color-source-sql-keyword">if</span> <span class="color-source-sql-keyword">exists</span> example <span class="color-source-sql-keyword">cascade</span>;
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">schema</span> example;

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.customer(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">varchar</span>(100) <span class="color-source-sql-keyword">not</span> <span class="color-source-sql-keyword">null</span>
);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.customer <span class="color-source-sql-keyword">values</span> (1,<span class="color-source-sql-string">'Horns'</span>),(2,<span class="color-source-sql-string">'Hooves'</span>);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.invoice(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,  
  number <span class="color-source-sql-keyword">varchar</span>(10),
  date date,  
  customer_id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">references</span> example.customer(id),
  amount <span class="color-source-sql-keyword">numeric</span>(20,2) 
);
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">table</span> example.invoice <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Invoice'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice.id <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Identifier'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice.number <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Number'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice.date <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Date'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice.customer_id <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Сustomer'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice.amount <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Amount'</span>;

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.product(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">varchar</span>(100) <span class="color-source-sql-keyword">not</span> <span class="color-source-sql-keyword">null</span>,
  code <span class="color-source-sql-keyword">varchar</span>(10) <span class="color-source-sql-keyword">not</span> <span class="color-source-sql-keyword">null</span>
);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.invoice_product(
  id serial <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  invoice_id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">references</span> example.invoice(id),   
  product_id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">references</span> example.product(id),  
  quantity <span class="color-source-sql-keyword">int</span>,
  color <span class="color-source-sql-keyword">char</span>(1) <span class="color-source-sql-keyword">check</span> (color <span class="color-source-sql-keyword">in</span> (<span class="color-source-sql-string">'R'</span>,<span class="color-source-sql-string">'G'</span>,<span class="color-source-sql-string">'B'</span>))  
);
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">table</span> example.invoice_product <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Product of invoice'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice_product.id <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Identifier'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice_product.invoice_id <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Invoice'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice_product.product_id <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Product'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice_product.quantity <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Quantity'</span>;
<span class="color-source-sql-keyword">comment</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">column</span> example.invoice_product.color <span class="color-source-sql-keyword">is</span> <span class="color-source-sql-string">'Color'</span>;
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">index</span> <span class="color-source-sql-keyword">on</span> example.invoice_product(invoice_id);

<span class="color-source-sql-comment">-- Enable history</span>
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);

<span class="color-source-sql-comment">-- Change data</span>
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.invoice <span class="color-source-sql-keyword">values</span> (12,<span class="color-source-sql-string">'#20'</span>, <span class="color-source-sql-keyword">current_date</span>, 1, 120.00);
<span class="color-source-sql-keyword">update</span> example.invoice <span class="color-source-sql-keyword">set</span> customer_id=2 <span class="color-source-sql-keyword">where</span> id=12;
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.product(id,<span class="color-source-sql-keyword">name</span>,code) <span class="color-source-sql-keyword">values</span> (101,<span class="color-source-sql-string">'Pensil'</span>,<span class="color-source-sql-string">'030'</span>),(102,<span class="color-source-sql-string">'Notebook'</span>,<span class="color-source-sql-string">'040'</span>);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.invoice_product(id, invoice_id, product_id, quantity, color) <span class="color-source-sql-keyword">values</span> (1,12,101,1000,<span class="color-source-sql-string">'R'</span>),(2,12,101,10,<span class="color-source-sql-string">'G'</span>);

<span class="color-source-sql-keyword">do</span> &dollar;&dollar;
<span class="color-source-sql-keyword">begin</span>
  <span class="color-source-sql-keyword">update</span> example.invoice_product <span class="color-source-sql-keyword">set</span> quantity=quantity+1,color=<span class="color-source-sql-string">'B'</span> <span class="color-source-sql-keyword">where</span> id=1;
  <span class="color-source-sql-keyword">delete</span> <span class="color-source-sql-keyword">from</span> example.invoice_product <span class="color-source-sql-keyword">where</span> id=2;
  <span class="color-source-sql-keyword">update</span> example.invoice <span class="color-source-sql-keyword">set</span> amount=150 <span class="color-source-sql-keyword">where</span> id=12;
<span class="color-source-sql-keyword">end</span>; 
&dollar;&dollar;;

<span class="color-source-sql-comment">-- Select all changes, first three columns provide chronological</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes() <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;

<span class="color-source-sql-comment">-- Select all changes with column id (immutable), insert detail by columns, without detail table example.invoice_product</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(hist_columns_insert=&#62;<span class="color-source-sql-keyword">true</span>, hist_columns_immutable=&#62;<span class="color-source-sql-keyword">true</span>, hist_tables_detail=&#62;<span class="color-source-sql-keyword">false</span>) <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3; 

<span class="color-source-sql-comment">-- Select partial changes by id with detail table, autocreated indexes provide fast execution</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(12) <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;

<span class="color-source-sql-comment">-- Equivalent with using union all  </span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(id=&#62;12, hist_tables_detail=&#62;<span class="color-source-sql-keyword">false</span>)
<span class="color-source-sql-keyword">union</span> <span class="color-source-sql-keyword">all</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_product_changes(invoice_id=&#62;12)
<span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;

<span class="color-source-sql-comment">-- Set description expression for columns row_desc and value_desc   </span>
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>, <span class="color-source-sql-string">''</span><span class="color-source-sql-string">'Invoice'</span><span class="color-source-sql-string">''</span>);   
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, &dollar;&dollar; <span class="color-source-sql-string">'Row #'</span>||&dollar;1.id||<span class="color-source-sql-string">' / '</span>||(<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">from</span> example.product <span class="color-source-sql-keyword">where</span> id=&dollar;1.product_id) &dollar;&dollar;);
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_value_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'color'</span>, &dollar;&dollar; <span class="color-source-sql-keyword">case</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'R'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Red'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'B'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Blue'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'G'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Green'</span> <span class="color-source-sql-keyword">else</span> &dollar;1 <span class="color-source-sql-keyword">end</span> &dollar;&dollar;);

<span class="color-source-sql-comment">-- Replace function for column db_user_name</span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> example.db_user_name(db_user <span class="color-source-sql-keyword">name</span>) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">varchar</span> <span class="color-source-sql-keyword">language</span> plpgsql <span class="color-source-sql-keyword">as</span> &dollar;&dollar; 
<span class="color-source-sql-keyword">begin</span> 
  return <span class="color-source-sql-string">'['</span>||db_user||<span class="color-source-sql-string">']'</span>;                                        
<span class="color-source-sql-keyword">end</span>; &dollar;&dollar;;
<span class="color-source-sql-keyword">call</span> pghist.hist_column_custom_function(<span class="color-source-sql-string">'db_user_name'</span>, <span class="color-source-sql-string">'example.db_user_name'</span>);
<span class="color-source-sql-comment">-- call pghist.hist_column_custom_function('db_user_name', 'pghist.hist_default_db_user_name');</span>
</pre>
</div>
<br>
Changes to a specific condition can be obtained using a <em>cross-join</em> with a list of primary keys.
To union history of multiple tables, function results can be combined using the <em>union all</em> operator.
For such queries, it is recommended to create wrapper functions.
<br><br>
For data schemas with a complex structure, it is recommended to create: functions [schema].[table]_changes_ui,
one hist_table_changes_ui data type and one webpage to display history of any table.
<br><br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 250px;">
<pre><span class="color-source-sql-comment">-- Create function that returns changes by date</span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> example.invoice_changes_ui_date(date_changes date) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">setof</span> pghist.hist_table_change <span class="color-source-sql-keyword">language</span> <span class="color-source-sql-keyword">sql</span> <span class="color-source-sql-keyword">security</span> <span class="color-source-sql-keyword">definer</span> <span class="color-source-sql-keyword">as</span> &dollar;&dollar;
  <span class="color-source-sql-keyword">select</span> c.*
    <span class="color-source-sql-keyword">from</span> (<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">distinct</span> id <span class="color-source-sql-keyword">from</span> example.invoice_hist <span class="color-source-sql-keyword">where</span> hist_timestamp::date=date_changes) h
    <span class="color-source-sql-keyword">cross</span> <span class="color-source-sql-keyword">join</span> example.invoice_changes(h.id) c
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;
&dollar;&dollar;;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes_ui_date(<span class="color-source-sql-keyword">current_date</span>);

<span class="color-source-sql-comment">-- Create function that returns changes to master and detail tables</span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> example.invoice_changes_ui_simple(id <span class="color-source-sql-keyword">int</span>) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">setof</span> pghist.hist_table_change <span class="color-source-sql-keyword">language</span> <span class="color-source-sql-keyword">sql</span> <span class="color-source-sql-keyword">security</span> <span class="color-source-sql-keyword">definer</span> <span class="color-source-sql-keyword">as</span> &dollar;&dollar;
  <span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(id=&#62;id,hist_tables_detail=&#62;<span class="color-source-sql-keyword">false</span>,hist_columns_insert=&#62;<span class="color-source-sql-keyword">true</span>)
  <span class="color-source-sql-keyword">union</span> <span class="color-source-sql-keyword">all</span>
  <span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_product_changes(invoice_id=&#62;id)
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;
&dollar;&dollar;;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes_ui_simple(12);

<span class="color-source-sql-comment">-- Create type with only necessary columns for the UI and cast function to it,</span>
<span class="color-source-sql-comment">-- type is created only once (as a rule, there is only one history view form per project) </span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">type</span> example.hist_table_change_ui <span class="color-source-sql-keyword">as</span> (
  <span class="color-source-sql-keyword">timestamp</span> timestamptz,
  operation_name <span class="color-source-sql-keyword">varchar</span>,
  db_user_name <span class="color-source-sql-keyword">varchar</span>,
  row_desc <span class="color-source-sql-keyword">text</span>,  
  column_comment <span class="color-source-sql-keyword">varchar</span>,      
  value_old_desc <span class="color-source-sql-keyword">text</span>,      
  value_new_desc <span class="color-source-sql-keyword">text</span>
);
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> example.hist_table_change_ui_cast(c pghist.hist_table_change) <span class="color-source-sql-keyword">returns</span> example.hist_table_change_ui <span class="color-source-sql-keyword">language</span> plpgsql <span class="color-source-sql-keyword">as</span> &dollar;&dollar;
<span class="color-source-sql-keyword">begin</span>
  return (c.<span class="color-source-sql-keyword">timestamp</span>,c.operation_name,c.db_user_name,c.row_desc,c.column_comment,c.value_old_desc,c.value_new_desc)::example.hist_table_change_ui; 
<span class="color-source-sql-keyword">end</span>; &dollar;&dollar;;
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">cast</span>(pghist.hist_table_change <span class="color-source-sql-keyword">as</span> example.hist_table_change_ui) <span class="color-source-sql-keyword">with</span> <span class="color-source-sql-keyword">function</span> example.hist_table_change_ui_cast <span class="color-source-sql-keyword">as</span> <span class="color-source-sql-keyword">assignment</span>;

<span class="color-source-sql-comment">-- Create function that returns only necessary columns</span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> example.invoice_changes_ui(id <span class="color-source-sql-keyword">int</span>) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">setof</span> example.hist_table_change_ui <span class="color-source-sql-keyword">language</span> <span class="color-source-sql-keyword">sql</span> <span class="color-source-sql-keyword">security</span> <span class="color-source-sql-keyword">definer</span> <span class="color-source-sql-keyword">as</span> &dollar;&dollar;
  <span class="color-source-sql-keyword">select</span> c::pghist.hist_table_change::example.hist_table_change_ui <span class="color-source-sql-keyword">from</span> ( 
    <span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(id=&#62;id,hist_tables_detail=&#62;<span class="color-source-sql-keyword">false</span>,hist_columns_insert=&#62;<span class="color-source-sql-keyword">true</span>)
    <span class="color-source-sql-keyword">union</span> <span class="color-source-sql-keyword">all</span>
    <span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_product_changes(invoice_id=&#62;id)
    <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3
  ) c;  
&dollar;&dollar;;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes_ui(12);
</pre>
</div>
<br>
<br>
<b>3. <a href="#table_at_timestamp">[schema].[table]_at_timestamp </a> function</b> creates copy of table (temporary table) at a point in time in the past and returns it
<br><br>
Used for data recovery and SQL queries from multiple tables at a point in time in the past,
can be joined to the [schema].[table]_hist view by primary key.
<br><br>
For optimazation of SQL queries, the created temporary table has indexes similar to original,
recovery time can be set once in the <em>pghist.at_timestamp</em> parameter.
<br><br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 250px;">
<pre><span class="color-source-sql-comment">--  Create schema and tables, enable history</span>
<span class="color-source-sql-keyword">drop</span> <span class="color-source-sql-keyword">schema</span> <span class="color-source-sql-keyword">if</span> <span class="color-source-sql-keyword">exists</span> example <span class="color-source-sql-keyword">cascade</span>;
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">schema</span> example;

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.customer(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">varchar</span>(100) <span class="color-source-sql-keyword">not</span> <span class="color-source-sql-keyword">null</span>
);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.customer <span class="color-source-sql-keyword">values</span> (1,<span class="color-source-sql-string">'Horns'</span>),(2,<span class="color-source-sql-string">'Hooves'</span>);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.<span class="color-source-sql-keyword">document</span>(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  number <span class="color-source-sql-keyword">varchar</span>(10),
  date date
);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example.invoice(
  <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span> (id),
  customer_id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">references</span> example.customer(id),
  amount <span class="color-source-sql-keyword">numeric</span>(20,2)
) <span class="color-source-sql-keyword">inherits</span> (example.<span class="color-source-sql-keyword">document</span>);
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">index</span> <span class="color-source-sql-keyword">on</span> example.invoice(customer_id);

<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'customer'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'document'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);

<span class="color-source-sql-comment">-- Enter data into tables   </span>
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.<span class="color-source-sql-keyword">document</span> <span class="color-source-sql-keyword">values</span> (11,<span class="color-source-sql-string">'#10'</span>, <span class="color-source-sql-keyword">current_date</span>);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.invoice  <span class="color-source-sql-keyword">values</span> (12,<span class="color-source-sql-string">'#20'</span>, <span class="color-source-sql-keyword">current_date</span>,   1, 120.00);
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example.invoice  <span class="color-source-sql-keyword">values</span> (13,<span class="color-source-sql-string">'#30'</span>, <span class="color-source-sql-keyword">current_date</span>-1, 2, 130.00);

<span class="color-source-sql-comment">-- Select data in past</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_at_timestamp(now()-<span class="color-source-sql-keyword">interval</span> <span class="color-source-sql-string">'10 second'</span>);

<span class="color-source-sql-comment">-- Erroneous update and recovery</span>
<span class="color-source-sql-keyword">update</span> example.invoice <span class="color-source-sql-keyword">set</span> customer_id=2,amount=300 <span class="color-source-sql-keyword">where</span> date=<span class="color-source-sql-keyword">current_date</span>;

<span class="color-source-sql-keyword">update</span> example.invoice i
    <span class="color-source-sql-keyword">set</span> amount = h.amount
  <span class="color-source-sql-keyword">from</span> example.invoice_at_timestamp(<span class="color-source-sql-string">'2024-04-06 10:00:00'</span>) h
  <span class="color-source-sql-keyword">where</span> i.id = h.id
    <span class="color-source-sql-keyword">and</span> i.date=<span class="color-source-sql-keyword">current_date</span>;

<span class="color-source-sql-comment">-- Сombination log and versioning   </span>
<span class="color-source-sql-keyword">select</span> * 
  <span class="color-source-sql-keyword">from</span> example.invoice_at_timestamp(<span class="color-source-sql-string">'2024-04-06 10:00:00'</span>)
  <span class="color-source-sql-keyword">where</span> id <span class="color-source-sql-keyword">in</span> (
          <span class="color-source-sql-keyword">select</span> id <span class="color-source-sql-keyword">from</span> example.invoice_hist
            <span class="color-source-sql-keyword">where</span> hist_timestamp&#62;<span class="color-source-sql-string">'2024-04-06 10:00:00'</span>
              <span class="color-source-sql-keyword">and</span> hist_db_user=<span class="color-source-sql-keyword">current_user</span>
        );

<span class="color-source-sql-comment">-- Сomplex query in past        </span>
<span class="color-source-sql-keyword">select</span> * 
  <span class="color-source-sql-keyword">from</span> example.invoice i
  <span class="color-source-sql-keyword">join</span> example.customer c <span class="color-source-sql-keyword">on</span> c.id=i.customer_id;
 
<span class="color-source-sql-keyword">do</span> &dollar;&dollar;
<span class="color-source-sql-keyword">begin</span>
  perform set_config(<span class="color-source-sql-string">'pghist.at_timestamp'</span>, <span class="color-source-sql-string">'2024-04-06 10:00:00'</span>, <span class="color-source-sql-keyword">true</span>);    
  perform example.invoice_at_timestamp();    
  perform example.customer_at_timestamp();
<span class="color-source-sql-keyword">end</span>; 
&dollar;&dollar;;
 
<span class="color-source-sql-keyword">select</span> * 
  <span class="color-source-sql-keyword">from</span> example_invoice_at_timestamp i
  <span class="color-source-sql-keyword">join</span> example_customer_at_timestamp c <span class="color-source-sql-keyword">on</span> c.id=i.customer_id;
</pre>
</div>


<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="security"></a>
<p style="font-size:larger;"><b>Security</b></p>
<br>
History table <a href="#hist_table">hist_data$[schema]_[table]</a> and trigger functions are created in pghist schema,
objects for working with history are created in the table schema.
Owner of all created objects is superuser, stored procedures are created with option <em>security definer</em>.
Owner of table is granted privilegies with grant option to select from view <a href="#view_hist">[schema].[table]_hist</a> and 
execute functions <a href="#table_changes">[schema].[table]_changes</a>, <a href="#table_at_timestamp">[schema].[table]_at_timestamp</a>.
<br><br>
If necessary, superuser grants select on <a href="#common_tables">common tables</a> to developer.
<br><br>
Data access is shown in <a href="https://github.com/PGSuite/PGHist/blob/main/documentation/data-schema.png" target="_blank">schema.</a>
<br><br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 250px;">
<pre><span class="color-source-sql-comment">-- postgres grant privileges on pghist schema and pghist.hist_enable procedure to developer_1</span>
<span class="color-source-sql-comment">-- all privileges in pghist_grants.sql file</span>
<span class="color-source-sql-keyword">grant</span> usage <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">schema</span> pghist <span class="color-source-sql-keyword">to</span> developer_1;
<span class="color-source-sql-keyword">grant</span> <span class="color-source-sql-keyword">execute</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">procedure</span> pghist.hist_enable(<span class="color-source-sql-keyword">name</span>) <span class="color-source-sql-keyword">to</span> developer_1;


<span class="color-source-sql-comment">-- developer_1 create table, enable history, grant privileges on example table and example_changes function to user_1</span>
<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">table</span> example(
  id <span class="color-source-sql-keyword">int</span> <span class="color-source-sql-keyword">primary</span> <span class="color-source-sql-keyword">key</span>,
  <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">varchar</span>(20),
  number <span class="color-source-sql-keyword">numeric</span>(10,2),
  date date
);

<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>);
  
<span class="color-source-sql-keyword">grant</span> <span class="color-source-sql-keyword">select</span>,<span class="color-source-sql-keyword">insert</span>,<span class="color-source-sql-keyword">update</span> <span class="color-source-sql-keyword">on</span> example <span class="color-source-sql-keyword">to</span> user_1;
<span class="color-source-sql-keyword">grant</span> <span class="color-source-sql-keyword">execute</span> <span class="color-source-sql-keyword">on</span> <span class="color-source-sql-keyword">function</span> example_changes <span class="color-source-sql-keyword">to</span> user_1;


<span class="color-source-sql-comment">-- user_1 change data and view changes </span>
<span class="color-source-sql-keyword">insert</span> <span class="color-source-sql-keyword">into</span> example <span class="color-source-sql-keyword">values</span> (1, <span class="color-source-sql-string">'Example'</span>, 10, <span class="color-source-sql-keyword">current_date</span>);
<span class="color-source-sql-keyword">update</span> example <span class="color-source-sql-keyword">set</span> number=20, date=date-1;

<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example_changes() <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;

<span class="color-source-sql-comment">-- When trying to select log, user_1 receives an error</span>
<span class="color-source-sql-comment">-- SQL Error [42501]: ERROR: permission denied for view example_hist </span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example_hist;
</pre>
</div>


<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_enable"></a>
<p style="font-size:larger;"><b>pghist.hist_enable</b>(schema, table_name, master_table_schema, master_table_name, columns_excluded)</p>
<br>
Procedure enable keeping history of changes for table, create history table, triggers and functions that return historical data
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>table schema (optional)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>table name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">master_table_schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>master table schema (optional)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">master_table_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>master table name (optional)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">columns_excluded</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name[]</td><td style="text-align: center; width: 30px;">-</td><td>excluded columns (optional)</td></tr>
</table>
<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 138px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'document'</span>);

<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);

<span class="color-source-sql-keyword">call</span> pghist.hist_enable(<span class="color-source-sql-string">'orm'</span>, <span class="color-source-sql-string">'myclass'</span>, columns_excluded =&#62; <span class="color-source-sql-keyword">array</span>[<span class="color-source-sql-string">'inserted_at'</span>,<span class="color-source-sql-string">'updated_at'</span>]);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="view_hist"></a>
<p style="font-size:larger;"><b>[schema].[table]_hist</b></p>
<br>
View contains a list of changes by row, created when history keeping is enabled.<br>Sorted by first two columns to provide chronology
<br>
<br>
Columns:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">bigint</td><td style="text-align: center; width: 30px;">-</td><td>common SQL statement number</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_row_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">bigint</td><td style="text-align: center; width: 30px;">-</td><td>row number in dataset that modified SQL statement</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_timestamp</td><td style="width: 5px;"></td><td style="white-space: nowrap;">timestamptz</td><td style="text-align: center; width: 30px;">-</td><td>SQL statement start date-time</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_operation</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>operation: INSERT,UPDATE,DELETE,TRUNCATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_update_columns</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name[]</td><td style="text-align: center; width: 30px;">-</td><td>changed columns for UPDATE operation</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_db_user</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>database user</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_app_user</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application user defined as current_setting('app.user')</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_application_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_query_text</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>SQL query text</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_id</td><td style="width: 5px;"></td><td style="white-space: nowrap;">bigint</td><td style="text-align: center; width: 30px;">-</td><td>SQL statement ID referenced on pghist.hist_statement table</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[primary key column(s)]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>primary key value (can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column(s) of fkey on master table]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>foreign key value on master table (optional, can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column...]_old</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>old value for each column of table [schema].[table]</td></tr>
</table>

<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 84px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist <span class="color-source-sql-keyword">where</span> id=2;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_hist <span class="color-source-sql-keyword">where</span> hist_operation=<span class="color-source-sql-string">'DELETE'</span>;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="table_changes"></a>
<p style="font-size:larger;"><b>[schema].[table]_changes</b>(hist_columns_immutable, hist_columns_insert, hist_tables_detail, hist_tables_inherited)</p>
<br>
Function return changes in the table (setof pghist.table_change), created when history keeping is enabled.<br>Sorting by the first three columns provides chronology by time, to get related data from multiple tables, recommended to use operator <em>union all</em>
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[primary key column(s)]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>primary key value (optional, can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column(s) of fkey on master table]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>foreign key value on master table (optional, can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_columns_immutable</td><td style="width: 5px;"></td><td style="white-space: nowrap;">boolean</td><td style="text-align: center; width: 30px;">-</td><td>return values of immutable columns (optional, default false)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_columns_insert</td><td style="width: 5px;"></td><td style="white-space: nowrap;">boolean</td><td style="text-align: center; width: 30px;">-</td><td>detail INSERT operation by column (optional, default false)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_tables_detail</td><td style="width: 5px;"></td><td style="white-space: nowrap;">boolean</td><td style="text-align: center; width: 30px;">-</td><td>return changes in detail tables (optional, default true)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_tables_inherited</td><td style="width: 5px;"></td><td style="white-space: nowrap;">boolean</td><td style="text-align: center; width: 30px;">-</td><td>process inherited tables (optional, default true)</td></tr>
</table>
<br>
Returned dataset columns (type pghist.hist_table_change):<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">statement_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">bigint</td><td style="text-align: center; width: 30px;">-</td><td>common SQL statement number</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">row_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">int</td><td style="text-align: center; width: 30px;">-</td><td>row number in dataset that modified SQL statement</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">int</td><td style="text-align: center; width: 30px;">-</td><td>column number in row</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">timestamp</td><td style="width: 5px;"></td><td style="white-space: nowrap;">timestamptz</td><td style="text-align: center; width: 30px;">-</td><td>operation date-time</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>operation: INSERT,UPDATE,DELETE,TRUNCATE</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>operation name, specified by the overridden function pghist.hist_custom_operation_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>column name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_comment</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>column comment</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_old</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>old value</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_old_desc</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>description of old value, can be overridden by the procedure pghist.hist_expression_value_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_new</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>new value</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">value_new_desc</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>description of new value, can be overridden by the procedure pghist.hist_expression_value_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">row_desc</td><td style="width: 5px;"></td><td style="white-space: nowrap;">text</td><td style="text-align: center; width: 30px;">-</td><td>description of row, can be overridden by the procedure pghist.hist_expression_row_desc</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>database user</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>database user name, specified by the overridden function pghist.hist_custom_db_user_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application user, specified by the overridden function pghist.hist_custom_app_user</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application user name, specified by the overridden function pghist.hist_custom_app_user_name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>schema</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>table name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_comment</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>table comment</td></tr>
</table>

<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 192px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes() <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(hist_columns_immutable=&#62;<span class="color-source-sql-keyword">true</span>) <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3; 

<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(12) <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;

<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_changes(id=&#62;12, hist_columns_insert=&#62;<span class="color-source-sql-keyword">true</span>, hist_tables_detail=&#62;<span class="color-source-sql-keyword">false</span>)
<span class="color-source-sql-keyword">union</span> <span class="color-source-sql-keyword">all</span>
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.invoice_product_changes(invoice_id=&#62;12)
<span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1,2,3;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="table_at_timestamp"></a>
<p style="font-size:larger;"><b>[schema].[table]_at_timestamp</b>(transaction_timestamp, cascade)</p>
<br>
Function created a temporary table [schema]_[table]_at_timestamp as copy of the original table at point in time and returns it
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>schema</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>table name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">transaction_timestamp</td><td style="width: 5px;"></td><td style="white-space: nowrap;">timestamptz</td><td style="text-align: center; width: 30px;">-</td><td>date-time of transaction completion, (optional, default current_setting(&#39;pghist.at_timestamp&#39;))</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">cascade</td><td style="width: 5px;"></td><td style="white-space: nowrap;">boolean</td><td style="text-align: center; width: 30px;">-</td><td>process inherited tables (optional, default true)</td></tr>
</table>
<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 246px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> example.document_at_timestamp(now()-<span class="color-source-sql-keyword">interval</span> <span class="color-source-sql-string">'1 hour'</span>);

<span class="color-source-sql-keyword">do</span> &dollar;&dollar;
<span class="color-source-sql-keyword">begin</span>
  perform set_config(<span class="color-source-sql-string">'pghist.at_timestamp'</span>, <span class="color-source-sql-string">'2024-04-06 10:00:00'</span>, <span class="color-source-sql-keyword">true</span>);    
  perform example.invoice_at_timestamp();    
  perform example.customer_at_timestamp();
<span class="color-source-sql-keyword">end</span>; 
&dollar;&dollar;;
<span class="color-source-sql-keyword">select</span> * 
  <span class="color-source-sql-keyword">from</span> example_invoice_at_timestamp i
  <span class="color-source-sql-keyword">join</span> example_customer_at_timestamp c <span class="color-source-sql-keyword">on</span> c.id=i.customer_id;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_disable"></a>
<p style="font-size:larger;"><b>pghist.hist_disable</b>(schema, table_name)</p>
<br>
Procedure disable keeping history of changes for table, delete the necessary objects
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>schema (optional)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>table name</td></tr>
</table>
<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 66px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_disable(<span class="color-source-sql-string">'document'</span>);
<span class="color-source-sql-keyword">call</span> pghist.hist_disable(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_expression_desc"></a>
<p style="font-size:larger;"><b>SQL expressions of descriptions</b></p>
<br>
<b>pghist.hist_expression_row_desc</b>(schema, table_name, expression)<br><b>pghist.hist_expression_value_desc</b>(schema, table_name, column_name, expression)<br><br>The procedures set expression to describe row or value of field.<br>Variable <em>$1</em> with row/field value is available in expression<br><br><br><b>pghist.hist_expression_row_desc_current</b>(schema, table_name)<br><b>pghist.hist_expression_value_desc_current</b>(schema, table_name, column_name)<br><br>Functions return current expression to describe row or value of field<br><br><br><b>pghist.hist_expression_row_desc_default</b>(schema, table_name)<br><b>pghist.hist_expression_value_desc_default</b>(schema, table_name, column_name)<br><br>Functions return default expression to describe row or value of field.<br>For row, table comment with the primary key is returned.<br>For column that is foreign key, first text field of foreigned table is returned.<br>
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">schema</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>schema</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">table</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>table name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>column name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">expression</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>expression, null discards the saved description</td></tr>
</table>
<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 138px;">
<pre><span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice'</span>, <span class="color-source-sql-string">''</span><span class="color-source-sql-string">'Invoice'</span><span class="color-source-sql-string">''</span>);   
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_row_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, &dollar;&dollar; <span class="color-source-sql-string">'Row #'</span>||&dollar;1.id||<span class="color-source-sql-string">' / '</span>||(<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">from</span> example.product <span class="color-source-sql-keyword">where</span> id=&dollar;1.product_id) &dollar;&dollar;);
<span class="color-source-sql-keyword">call</span> pghist.hist_expression_value_desc(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'color'</span>, &dollar;&dollar; <span class="color-source-sql-keyword">case</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'R'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Red'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'B'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Blue'</span> <span class="color-source-sql-keyword">when</span> &dollar;1=<span class="color-source-sql-string">'G'</span> <span class="color-source-sql-keyword">then</span> <span class="color-source-sql-string">'Green'</span> <span class="color-source-sql-keyword">else</span> &dollar;1 <span class="color-source-sql-keyword">end</span> &dollar;&dollar;);

<span class="color-source-sql-keyword">select</span> pghist.hist_expression_row_desc_current(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>);
<span class="color-source-sql-keyword">select</span> pghist.hist_expression_value_desc_default(<span class="color-source-sql-string">'example'</span>, <span class="color-source-sql-string">'invoice_product'</span>, <span class="color-source-sql-string">'color'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_custom_funcs"></a>
<p style="font-size:larger;"><b>Customization functions</b></p>
<br>
To customize and localize fields in a specific application, can be define custom functions.<br>Recommended to use the default function in SQL manager (such as pgAdmin or DBeaver), override it and save in application schema as different name
<br>
<br>
Columns available for customization:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">operation_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>operation name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">db_user_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>database user name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application user</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_user_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>application user name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_client_addr</td><td style="width: 5px;"></td><td style="white-space: nowrap;">inet</td><td style="text-align: center; width: 30px;">-</td><td>client application IP address</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">app_client_hostname</td><td style="width: 5px;"></td><td style="white-space: nowrap;">varchar</td><td style="text-align: center; width: 30px;">-</td><td>client application host name</td></tr>
</table>


<br>
<p style="font-size:larger;"><b>pghist.hist_column_custom_function</b>(column_name, custom_function)</p>
<br>
The procedure sets function to get column value
<br>
<br>
Parameters:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>column name</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">custom_function</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>function name without parameters</td></tr>
</table>

<br>
<p style="font-size:larger;"><b>pghist.hist_column_custom_function</b>(column_name)</p>
<br>
The function returns current function to get column value
<br>
<br>
Parameter:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">column_name</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name</td><td style="text-align: center; width: 30px;">-</td><td>column name</td></tr>
</table>

<br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 175px;">
<pre><span class="color-source-sql-keyword">select</span> pghist.hist_column_custom_function_current(<span class="color-source-sql-string">'db_user_name'</span>);

<span class="color-source-sql-keyword">create</span> <span class="color-source-sql-keyword">or</span> <span class="color-source-sql-keyword">replace</span> <span class="color-source-sql-keyword">function</span> myapp.user_name(db_user <span class="color-source-sql-keyword">name</span>) <span class="color-source-sql-keyword">returns</span> <span class="color-source-sql-keyword">varchar</span> <span class="color-source-sql-keyword">language</span> plpgsql <span class="color-source-sql-keyword">as</span> &dollar;&dollar; 
<span class="color-source-sql-keyword">begin</span> 
  return (<span class="color-source-sql-keyword">select</span> <span class="color-source-sql-keyword">name</span> <span class="color-source-sql-keyword">from</span> myapp.users <span class="color-source-sql-keyword">where</span> login=db_user);                                        
<span class="color-source-sql-keyword">end</span>; &dollar;&dollar;;

<span class="color-source-sql-keyword">call</span> pghist.hist_column_custom_function(<span class="color-source-sql-string">'db_user_name'</span>, <span class="color-source-sql-string">'myapp.user_name'</span>);
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_table"></a>
<p style="font-size:larger;"><b>History table pghist.hist_data$[schema]_[table]</b></p>
<br>
History table is created in addition to the main table, developer (owner of main table) has access through the view <a href="#view_hist">[schema].[table]_hist</a>
<br>
<br>
Columns:<br>
<table>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_statement_id</td><td style="width: 5px;"></td><td style="white-space: nowrap;">bigint</td><td style="text-align: center; width: 30px;">-</td><td>SQL statement ID referenced on pghist.hist_statement table</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_row_num</td><td style="width: 5px;"></td><td style="white-space: nowrap;">int</td><td style="text-align: center; width: 30px;">-</td><td>row number in dataset that modified SQL statement</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">hist_update_columns</td><td style="width: 5px;"></td><td style="white-space: nowrap;">name[]</td><td style="text-align: center; width: 30px;">-</td><td>changed columns for UPDATE operation</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[primary key column(s)]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>primary key value (can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column(s) of fkey on master table]</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>foreign key value on master table (optional, can be several)</td></tr>
  <tr><td style="width: 10px;"></td><td style="white-space: nowrap;">[column...]_old</td><td style="width: 5px;"></td><td style="white-space: nowrap;"></td><td style="text-align: center; width: 30px;">-</td><td>old value for each column of table [schema].[table]</td></tr>
</table>

<br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 120px;">
<pre><span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_data&dollar;example_invoice h
  <span class="color-source-sql-keyword">join</span> pghist.hist_statement s <span class="color-source-sql-keyword">on</span> s.id=h.hist_statement_id
  <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash=s.query_hash
  <span class="color-source-sql-keyword">where</span> q.<span class="color-source-sql-keyword">text</span> <span class="color-source-sql-keyword">like</span> <span class="color-source-sql-string">'do%begin%'</span>;
</pre>
</div>

<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="common_tables"></a>
<p style="font-size:larger;"><b>Common tables</b></p>
<br>
<table>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_transaction</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">transactions</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_query</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">SQL queries</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_statement</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">SQL statements</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_table</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">history tables</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_table_column</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">columns of history tables</td></tr>
  <tr><td style="white-space: nowrap;"><b>pghist.hist_column_custom_function</b></td><td style="text-align: center; width: 30px;">-</td><td style="padding-top: 5px; padding-bottom: 5px;">custom functions of columns</td></tr>
</table>


<br>
On installation created tables that store common data
(transaction date-time and SQL expressions, operation, SQL query, user, session, etc) 
and tables with settings.
Modification of common tables is allowed using stored procedures.
By default, developers (owners of main tables) do not have access to common tables; if necessary, privilegies are granted manually.
<br>
<br>
History table <a href="#hist_table">pghist.hist_data$[schema]_[table]</a> by field <em>statement_id</em> refers to <em>pghist.hist_statement</em>, which in, in turn, refers to <em>pghist.hist_transaction</em> and <em>pghist.hist_query</em>.

<br>
<br>
Example:<br>
<div class="div-source-code border-color-div-source-code" style="height: 190px;">
<pre><span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_statement s
  <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id=s.transaction_id
  <span class="color-source-sql-keyword">join</span> pghist.hist_query q <span class="color-source-sql-keyword">on</span> q.hash=s.query_hash
  <span class="color-source-sql-keyword">where</span> t.timestamp_commit <span class="color-source-sql-keyword">between</span> <span class="color-source-sql-string">'2024-04-06 10:00:00'</span> <span class="color-source-sql-keyword">and</span> <span class="color-source-sql-string">'2024-04-06 11:00:00'</span>;

<span class="color-source-sql-keyword">select</span> *
  <span class="color-source-sql-keyword">from</span> pghist.hist_table ht
  <span class="color-source-sql-keyword">left</span> <span class="color-source-sql-keyword">join</span> pghist.hist_table_column htc <span class="color-source-sql-keyword">on</span> htc.<span class="color-source-sql-keyword">schema</span>=ht.<span class="color-source-sql-keyword">schema</span> <span class="color-source-sql-keyword">and</span> htc.table_name=ht.<span class="color-source-sql-keyword">name</span>;
</pre>
</div>


<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="pghist_version"></a>
<p style="font-size:larger;"><b>pghist.pghist_version</b></p>
<br>
The function returns tool version
<br>


<div style="height: 25px;"></div>
<div class="background-menu-line" style="width: 100%; height: 2px; padding: 0px; margin-bottom: 15px;"></div>


<a id="hist_sql_log"></a>
<p style="font-size:larger;"><b>pghist.hist_sql_log</b></p>
<br>
All executed commands logging in table pghist.hist_sql_log
<br>
<br>
Examples:<br>
<div class="div-source-code border-color-div-source-code" style="height: 120px;">
<pre><span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> pghist.hist_sql_log <span class="color-source-sql-keyword">where</span> <span class="color-source-sql-keyword">schema</span>=<span class="color-source-sql-string">'example'</span> <span class="color-source-sql-keyword">and</span> table_name=<span class="color-source-sql-string">'document'</span> <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> id;
<span class="color-source-sql-keyword">select</span> * <span class="color-source-sql-keyword">from</span> pghist.hist_sql_log l
  <span class="color-source-sql-keyword">join</span> pghist.hist_transaction t <span class="color-source-sql-keyword">on</span> t.id=l.transaction_id
  <span class="color-source-sql-keyword">where</span> <span class="color-source-sql-keyword">schema</span>=<span class="color-source-sql-string">'example'</span> <span class="color-source-sql-keyword">and</span> table_name=<span class="color-source-sql-string">'document'</span>
  <span class="color-source-sql-keyword">order</span> <span class="color-source-sql-keyword">by</span> 1 <span class="color-source-sql-keyword">desc</span>;
</pre>
</div>

<br>


  </div>

</div>

</body>
</html>